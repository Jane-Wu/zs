<?php

/**
 * Implements hook_theme().
 */
function capital_common_get_rest_api($url, $headers = array()) {
  \Drupal::logger('capital-rest')->notice('URL ' . print_r($url, true));
  $ch = curl_init();
  curl_setopt($ch, CURLOPT_URL, $url);
  curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
  curl_setopt($ch, CURLOPT_REFERER, "capital-dev");
  curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
  $body = curl_exec($ch);
  curl_close($ch);

  if($body == null){
    \Drupal::logger('capital-rest')->notice('No return, invalid url ' . print_r($url, true));
  }

  return json_decode($body);
}
function capital_common_get_rest_custom_search($key, $orterms = null, $sort = 'date') {
  if( empty($key)){
    return;
  }
  $encoded_key = strpos($key, ' ') !== false? implode('+', array_map('_capital_common_wrap_search_key', explode(' ', $key))): '"' . urlencode($key) . '"';
  //$config = \Drupal::config('capital_news.settings');
  //$url = 'https://www.googleapis.com/customsearch/v1?key=' . $config->get('search.apikey') . '&cx=' . $config->get('search.csekey') . '&filter=1&dateRestrict=d1&q=' . $encoded_key; 
  $url = 'https://www.googleapis.com/customsearch/v1?key=AIzaSyB406FpOxPYJFYVdNambqiHCAPexkBaqJE&cx=004400752527919370638:64owq-rlmuw&filter=1&dateRestrict=d1&q=' . $encoded_key; 
  if($sort){
    $url = $url . '&sort=' . $sort;
  }
  if($orterms){
    $url = $url . '&orTerms=' . (strpos($orterms, ' ') !== false? implode('+', array_map('_capital_common_wrap_search_key', explode(' ', $orterms))): '"' . urlencode($orterms) . '"');
  }

  $results = capital_common_get_rest_api($url);
  if(isset($results->error)){
    \Drupal::logger('capital-rest')->error('Error ' . print_r($results, true));
  }
  return $results;
}
function capital_common_get_wechat_search($key){
  $encoded_key = strpos($key, ' ') !== false? implode('+', array_map('_capital_common_wrap_search_key', explode(' ', $key))): '"' . urlencode($key) . '"';
  $url = "http://52.78.11.123/keyword-day/" . $encoded_key;
  $results = capital_common_get_rest_api($url);
  \Drupal::logger('capital-wechat')->error( print_r($results, true));
  return $results;
}
function _capital_common_wrap_search_key($key){
  return '"' . urlencode($key) . '"';
}
function capital_common_get_wechat_offical_search($account_name) {
  $url = "http://52.78.11.123/account/" . $account_name;
  return (capital_common_get_rest_api($url));
}
function capital_common_get_wechat_offical_test_search($account_name) {
  $url = "http://api.aerchi.com/weixin/api.php?wxID=" . $account_name . "&key=FR2sIR7jULp2dVhw2CURrSVfhjvgGVlLNK2C6Vshy3IQhDJL+G2uqw";
  return (capital_common_get_rest_api($url));
}
